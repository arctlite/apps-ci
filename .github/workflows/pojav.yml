name: "Build PojavLauncher Daily ☀️"

on:
  schedule:
    - cron: '0 0 * * *'  # A new day, a new adventure! 🌅
  workflow_dispatch: 

jobs:
  build:
    # Our reliable builder buddy 🛠️
    runs-on: ubuntu-22.04

    env:
      CURSEFORGE_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}

    steps:
      # 🏡 Starting with a clean slate!
      - name: "🏡 Start Fresh"
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Only the essentials! 🎒

      # 🌟 Set up repository details
      - name: "📂 Prepare Repository Details"
        run: |
          REPO_URL="https://github.com/PojavLauncherTeam/PojavLauncher.git"
          REPO_DIR="pojav"
          echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV
          echo "REPO_DIR=$REPO_DIR" >> $GITHUB_ENV

      - name: "🌟 Clone Repository"
        run: |
          echo "Cloning $REPO_URL into $REPO_DIR... 🌀"
          git clone $REPO_URL --depth 1 $REPO_DIR
          echo "Repository cloned successfully! 📦"

      - name: "📝 Extract Commit Details"
        run: |
          cd $REPO_DIR
          SHORT_COMMIT_HASH=$(git rev-parse --short HEAD)
          CURRENT_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          CURRENT_COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          CURRENT_COMMIT_DATE=$(git log -1 --pretty=format:"%cd" --date=short)
          echo "Commit Details: 📝"
          echo "  Short Hash: $SHORT_COMMIT_HASH"
          echo "  Message: $CURRENT_COMMIT_MSG"
          echo "  Author: $CURRENT_COMMIT_AUTHOR"
          echo "  Date: $CURRENT_COMMIT_DATE"
          echo "SHORT_COMMIT_HASH=$SHORT_COMMIT_HASH" >> $GITHUB_ENV
          echo "CURRENT_COMMIT_MSG=$CURRENT_COMMIT_MSG" >> $GITHUB_ENV
          echo "CURRENT_COMMIT_AUTHOR=$CURRENT_COMMIT_AUTHOR" >> $GITHUB_ENV
          echo "CURRENT_COMMIT_DATE=$CURRENT_COMMIT_DATE" >> $GITHUB_ENV

      # 🔄 Compare the current and previous builds
      - name: "🔄 Compare Commit Hashes"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for previous builds... 🕵️‍♀️"
          gh release download --repo arctlite/apps-ci --pattern "commit_hash.txt" --dir ./release_info || echo "No previous build info found! Starting fresh. 🌱"

          if [ -f ./release_info/commit_hash.txt ]; then
            PREVIOUS_COMMIT_HASH=$(cat ./release_info/commit_hash.txt)
            echo "Found previous commit hash: $PREVIOUS_COMMIT_HASH 🗂️"
          else
            echo "No previous commit hash. It's a clean start! 🌟"
            PREVIOUS_COMMIT_HASH=""
          fi

          if [ "$PREVIOUS_COMMIT_HASH" == "$SHORT_COMMIT_HASH" ]; then
            echo "No changes detected since the last build. Take the day off! 🌴"
            exit 1  # Exiting gracefully to save resources
          else
            echo "New changes spotted—let's get to work! 🛠️"
          fi

      - name: "🌿 Brew Some Java (JDK 17)"
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: "🛠️ Build APKs"
        run: |
          cd $REPO_DIR
          ../scripts/pojav/build_apks.sh
          echo "APKs built to perfection! 🏗️"

      - name: "🖋️ Sign APKs"
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cd $REPO_DIR
          ../scripts/pojav/sign_apks.sh
          echo "Signed, sealed, and ready to deliver! 📜📦"

      - name: "📦 Create GitHub Release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating a shiny new release! ✨"
          TAG_NAME="pojavlauncher-${{ env.SHORT_COMMIT_HASH }}"
          gh release create "$TAG_NAME" \
            --title "PojavLauncher Build (${TAG_NAME})" \
            --notes "✨ Automated build of PojavLauncher. ✨

            **Commit Details**
            - **Hash**: ${{ env.SHORT_COMMIT_HASH }}
            - **Message**: ${{ env.CURRENT_COMMIT_MSG }}
            - **Author**: ${{ env.CURRENT_COMMIT_AUTHOR }}
            - **Date**: ${{ env.CURRENT_COMMIT_DATE }}" \
            --target main

      - name: "📤 Upload Each APK to Release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Sending the APKs off to their new home! 🏠"
          for apk in $REPO_DIR/app_pojavlauncher/build/outputs/apk/release/*.apk; do
            gh release upload "pojavlauncher-${{ env.SHORT_COMMIT_HASH }}" "$apk"
          done

      - name: "📤 Upload Commit Hash to Release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Saving the commit hash for posterity. 📖"
          echo ${{ env.SHORT_COMMIT_HASH }} > commit_hash.txt
          gh release upload "pojavlauncher-${{ env.SHORT_COMMIT_HASH }}" "commit_hash.txt"
          echo "Commit hash uploaded successfully! 📝"

      - name: "📤 Sharing the Results (Discord)"
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_BRANCH: ${{ github.ref_name }}
          GITHUB_COMMIT: ${{ github.sha }}
        run: |
          cd $REPO_DIR
          ../scripts/pojav/discord_upload.sh
          echo "Results shared with the world—mission accomplished! 🌍"

